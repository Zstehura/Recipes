@page "/grocery-list"
@using RecipesApp.Models
@using RecipesApp.Services
@inject RecipeService RecipeService
@inject GroceryListService GroceryListService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Grocery List</PageTitle>

<div class="mb-4">
    <h1 class="mb-2">Grocery List Generator</h1>
    <p class="text-muted">Select recipes and specify quantities to generate a combined grocery list.</p>
</div>

<div class="mb-3">
    <div class="row g-2">
        <div class="col-12 col-md-6">
            <input type="text" class="form-control" placeholder="Search recipes..." @bind="searchTerm" @bind:event="oninput" @bind:after="LoadRecipes" />
        </div>
        <div class="col-12 col-md-6 text-md-end">
            <button class="btn btn-outline-secondary w-100 w-md-auto" @onclick="ToggleFilters" type="button">
                <span class="bi bi-funnel"></span> @(showFilters ? "Hide" : "Show") Filters
            </button>
        </div>
    </div>
</div>

@if (showFilters)
{
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title mb-3">Filter Recipes</h5>
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <label class="form-label">Cook Time (minutes)</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="number" class="form-control" placeholder="Min" min="1" @bind="minCookTime" @bind:event="onchange" @bind:after="LoadRecipes" />
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control" placeholder="Max" min="1" @bind="maxCookTime" @bind:event="onchange" @bind:after="LoadRecipes" />
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label">Servings</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="number" class="form-control" placeholder="Min" min="1" @bind="minServings" @bind:event="onchange" @bind:after="LoadRecipes" />
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control" placeholder="Max" min="1" @bind="maxServings" @bind:event="onchange" @bind:after="LoadRecipes" />
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <label class="form-label">Tags</label>
                    @if (availableTags == null)
                    {
                        <p class="text-muted small">Loading tags...</p>
                    }
                    else if (!availableTags.Any())
                    {
                        <p class="text-muted small">No tags available</p>
                    }
                    else
                    {
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var tag in availableTags)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="grocery-tag-@tag" checked="@selectedTags.Contains(tag)" @onchange="@((e) => ToggleTag(tag, e.Value))" />
                                    <label class="form-check-label" for="grocery-tag-@tag">
                                        @tag
                                    </label>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="col-12">
                    <button class="btn btn-outline-danger btn-sm" @onclick="ClearFilters">
                        <span class="bi bi-x-circle"></span> Clear All Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<div class="row g-3">
    <!-- Left Column: Recipe Selection -->
    <div class="col-12 col-md-8">
        @if (recipes == null)
        {
            <p><em>Loading recipes...</em></p>
        }
        else if (!recipes.Any())
        {
            <div class="alert alert-info">
                <p>No recipes available. <a href="/recipe/new">Create your first recipe!</a></p>
            </div>
        }
        else
        {
            <div class="row g-3">
                @foreach (var recipe in recipes)
                {
                    var isSelected = selectedRecipeMultipliers.ContainsKey(recipe.Id);
                    <div class="col-12 col-sm-6 col-lg-6">
                        <div class="card h-100 @(isSelected ? "border-primary" : "")" style="@(isSelected ? "box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);" : "")">
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="recipe-@recipe.Id"
                                           checked="@isSelected"
                                           @onchange="@((e) => ToggleRecipeSelection(recipe.Id, e.Value))" />
                                    <label class="form-check-label fw-bold" for="recipe-@recipe.Id">
                                        @recipe.Name
                                    </label>
                                </div>

                                <p class="card-text mb-2">
                                    <small class="text-muted">
                                        <span class="bi bi-clock"></span> @recipe.CookingTime min
                                        <span class="ms-2 bi bi-people"></span> @recipe.Servings servings
                                    </small>
                                </p>

                                @if (!string.IsNullOrEmpty(recipe.Tags))
                                {
                                    <div class="mb-2">
                                        @foreach (var tag in recipe.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                                        {
                                            <span class="badge bg-secondary me-1">@tag</span>
                                        }
                                    </div>
                                }

                                @if (recipe.RecipeIngredients != null && recipe.RecipeIngredients.Any())
                                {
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <span class="bi bi-basket"></span> @recipe.RecipeIngredients.Count ingredient@(recipe.RecipeIngredients.Count > 1 ? "s" : "")
                                        </small>
                                    </p>
                                }

                                @if (isSelected)
                                {
                                    <div class="mt-3">
                                        <label class="form-label small text-muted">Quantity (how many times to include this recipe)</label>
                                        <input type="number" class="form-control form-control-sm" min="1" max="10"
                                               value="@selectedRecipeMultipliers[recipe.Id]"
                                               @onchange="@((e) => UpdateMultiplier(recipe.Id, e.Value))" />
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Right Column: Summary and Actions -->
    <div class="col-12 col-md-4">
        <div class="card sticky-top" style="top: 1rem;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Summary</h5>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    <strong>@selectedRecipeMultipliers.Count</strong> recipe@(selectedRecipeMultipliers.Count != 1 ? "s" : "") selected
                </p>

                @if (selectedRecipeMultipliers.Any())
                {
                    <div class="mb-3">
                        <small class="text-muted">Selected recipes:</small>
                        <ul class="list-unstyled mt-2">
                            @foreach (var item in selectedRecipeMultipliers)
                            {
                                <li class="mb-1">
                                    <small>
                                        @item.Value x @(selectedRecipeNames.GetValueOrDefault(item.Key, "Unknown"))
                                    </small>
                                </li>
                            }
                        </ul>
                    </div>
                }

                <div class="d-grid gap-2">
                    <button class="btn btn-primary"
                            @onclick="GenerateGroceryListAsync"
                            disabled="@(!selectedRecipeMultipliers.Any() || isGenerating)">
                        @if (isGenerating)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        else
                        {
                            <span class="bi bi-cart-check me-2"></span>
                        }
                        Generate List
                    </button>

                    @if (selectedRecipeMultipliers.Any())
                    {
                        <button class="btn btn-outline-secondary" @onclick="ClearSelection">
                            <span class="bi bi-x-circle"></span> Clear Selection
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(generatedGroceryList))
{
    <div class="row g-3 mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Your Grocery List</h5>
                    <button class="btn btn-sm btn-light" @onclick="CopyToClipboardAsync">
                        <span class="bi bi-clipboard"></span> Copy
                    </button>
                </div>
                <div class="card-body">
                    <textarea class="form-control font-monospace" rows="20" readonly style="resize: vertical;">@generatedGroceryList</textarea>
                    @if (!string.IsNullOrEmpty(copyMessage))
                    {
                        <div class="alert alert-success mt-2 mb-0">
                            @copyMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Recipe>? recipes;
    private Dictionary<int, int> selectedRecipeMultipliers = new();
    private Dictionary<int, string> selectedRecipeNames = new();
    private string? generatedGroceryList;
    private bool isGenerating = false;
    private string? copyMessage;
    private string searchTerm = string.Empty;
    private bool showFilters = false;
    private int? minCookTime;
    private int? maxCookTime;
    private int? minServings;
    private int? maxServings;
    private List<string> availableTags = new();
    private HashSet<string> selectedTags = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRecipes();
        await LoadAvailableTags();
    }

    private async Task LoadRecipes()
    {
        var hasFilters = minCookTime.HasValue || maxCookTime.HasValue ||
                        minServings.HasValue || maxServings.HasValue ||
                        selectedTags.Any() || !string.IsNullOrWhiteSpace(searchTerm);

        if (!hasFilters)
        {
            recipes = await RecipeService.GetAllRecipesAsync();
        }
        else
        {
            recipes = await RecipeService.FilterRecipesAsync(
                searchTerm: string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
                minCookTime: minCookTime,
                maxCookTime: maxCookTime,
                tags: selectedTags.Any() ? selectedTags.ToList() : null,
                minServings: minServings,
                maxServings: maxServings
            );
        }
        StateHasChanged();
    }

    private async Task LoadAvailableTags()
    {
        availableTags = await RecipeService.GetAllTagsAsync();
        StateHasChanged();
    }

    private void ToggleRecipeSelection(int recipeId, object? isChecked)
    {
        if (isChecked is bool checkedValue)
        {
            if (checkedValue)
            {
                selectedRecipeMultipliers[recipeId] = 1;
                var recipe = recipes?.FirstOrDefault(r => r.Id == recipeId);
                if (recipe != null) selectedRecipeNames[recipeId] = recipe.Name;
            }
            else
            {
                selectedRecipeMultipliers.Remove(recipeId);
                selectedRecipeNames.Remove(recipeId);
            }
            StateHasChanged();
        }
    }

    private void UpdateMultiplier(int recipeId, object? value)
    {
        if (value is string strValue && int.TryParse(strValue, out var multiplier))
        {
            if (multiplier >= 1 && multiplier <= 10)
            {
                selectedRecipeMultipliers[recipeId] = multiplier;
                StateHasChanged();
            }
        }
    }

    private async Task GenerateGroceryListAsync()
    {
        isGenerating = true;
        copyMessage = null;
        StateHasChanged();

        try
        {
            generatedGroceryList = await GroceryListService.GenerateGroceryListAsync(selectedRecipeMultipliers);
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }

    private async Task ToggleTag(string tag, object? isChecked)
    {
        if (isChecked is bool checkedValue)
        {
            if (checkedValue)
            {
                selectedTags.Add(tag);
            }
            else
            {
                selectedTags.Remove(tag);
            }
            await LoadRecipes();
        }
    }

    private async Task ClearFilters()
    {
        searchTerm = string.Empty;
        minCookTime = null;
        maxCookTime = null;
        minServings = null;
        maxServings = null;
        selectedTags.Clear();
        await LoadRecipes();
    }

    private async Task ClearSelection()
    {
        selectedRecipeMultipliers.Clear();
        selectedRecipeNames.Clear();
        generatedGroceryList = null;
        copyMessage = null;
        await ClearFilters();
    }

    private async Task CopyToClipboardAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", generatedGroceryList);
            copyMessage = "Copied to clipboard!";
            StateHasChanged();

            // Clear message after 3 seconds
            await Task.Delay(3000);
            copyMessage = null;
            StateHasChanged();
        }
        catch
        {
            copyMessage = "Failed to copy. Please select and copy manually.";
            StateHasChanged();
        }
    }
}
